@model shortenUrl.MVC.Models.UrlVM

@{
    ViewData["Title"] = "Create";
}

<div class="container py-4">
    <div class="mb-4">
        <h2 class="text-primary fw-bold">
            <i class="bi bi-plus-circle me-2"></i> @ViewData["Title"] New Short URL
        </h2>
        <p class="text-muted">Enter the original URL and optionally customize the short version.</p>
    </div>

    <div class="row justify-content-center">
        <div class="col-md-6">
            <form asp-action="Create" method="post" class="shadow-sm p-4 rounded border bg-light">
                @Html.AntiForgeryToken()
                <div asp-validation-summary="ModelOnly" class="text-danger mb-3"></div>

                <div class="mb-3">
                    <label asp-for="OriginalUrl" class="form-label fw-semibold">
                        <i class="bi bi-link-45deg me-1 text-primary"></i> Original URL
                    </label>
                    <input asp-for="OriginalUrl" class="form-control" placeholder="https://example.com/your-link" />
                    <span asp-validation-for="OriginalUrl" class="text-danger small"></span>
                </div>

                <div class="mb-3">
                    <label asp-for="ShortenedUrl" class="form-label fw-semibold">
                        <i class="bi bi-pencil-square me-1 text-secondary"></i> Custom Short URL <span class="text-muted"></span>
                    </label>
                    <input asp-for="ShortenedUrl" class="form-control" placeholder="e.g. my-custom-code" />
                    <span asp-validation-for="ShortenedUrl" class="text-danger small"></span>

                    <div class="mt-2">
                        <button type="button" id="generateShortBtn" class="btn btn-sm btn-outline-secondary" aria-label="Generate random short code">
                            <i class="bi bi-shuffle me-1"></i> Generate random
                        </button>
                        <small class="text-muted ms-2">Click to fill a random short code (you can edit it later).</small>
                    </div>
                </div>

                <div class="d-flex justify-content-between align-items-center mt-4">
                    <a asp-action="Index" class="btn btn-outline-secondary">
                        <i class="bi bi-arrow-left me-1"></i>Back to List
                    </a>
                    <input type="submit" value="Create" class="btn btn-primary px-4" />
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }

    <script>
        (function () {
            const chars = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            const length = 5;

            function generateCode(len) {
                let result = '';
                const array = new Uint32Array(len);
                if (window.crypto && window.crypto.getRandomValues) {
                    window.crypto.getRandomValues(array);
                    for (let i = 0; i < len; i++) {
                        result += chars[array[i] % chars.length];
                    }
                } else {
                    for (let i = 0; i < len; i++) {
                        result += chars[Math.floor(Math.random() * chars.length)];
                    }
                }
                return result;
            }

            const btn = document.getElementById('generateShortBtn');
            if (btn) {
                btn.addEventListener('click', function () {
                    const input = document.getElementById('ShortenedUrl');
                    if (!input) return;
                    // generate and set value
                    input.value = generateCode(length);
                    // notify any listeners (validation, change detection)
                    input.dispatchEvent(new Event('input', { bubbles: true }));
                    input.dispatchEvent(new Event('change', { bubbles: true }));
                });
            }
        })();
    </script>
}
